name: 🧪 Test Action

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    
permissions:
  contents: write

jobs:
  test-fusion-publish:
    name: 🧪 Test Fusion Publish
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🔨 Build action
        run: npm run build

      - name: ✅ Check built action
        run: |
          if [ -f "dist/index.js" ]; then
            echo "✅ Built action found"
          else
            echo "❌ Built action not found"
            exit 1
          fi
        shell: bash

  test-action-dry-run:
    name: 🧪 Test Action (Dry Run)
    runs-on: ubuntu-latest
    needs: test-fusion-publish
    
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📦 Build action
        run: |
          npm ci
          npm run build

      - name: 🎯 Test Action Setup
        uses: ./
        with:
          tag: 'test-v1.0.0'
          stage: 'testing'
          api-id: 'test-api'
          api-key: 'test-key'
        continue-on-error: true

  create-tags:
    name: 🏷️ Create/Update Tags
    runs-on: ubuntu-latest
    needs: [test-fusion-publish, test-action-dry-run]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 🔨 Build action
        run: |
          npm ci
          npm run build

      - name: 📋 Commit built files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f dist/
          git diff --staged --quiet || git commit -m "🔨 Update built action"

      - name: 🏷️ Create/update version tags
        run: |
          git tag -fa v1 -m "Update v1 tag"
          git push origin v1 --force
          
          if ! git rev-parse v1.0 >/dev/null 2>&1; then
            git tag v1.0 -m "Create v1.0 tag"
            git push origin v1.0
          fi