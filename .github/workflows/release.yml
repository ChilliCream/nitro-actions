name: ğŸ§ª Test Action

on:
  push:
    branches: [main]
    tags: ['v*']  # Added tag trigger
  pull_request:
    branches: [main]
    
permissions:
  contents: write

jobs:
  test-fusion-publish:
    name: ğŸ§ª Test Fusion Publish
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build action
        run: npm run build

      - name: âœ… Check built action
        run: |
          if [ -f "dist/index.js" ]; then
            echo "âœ… Built action found"
          else
            echo "âŒ Built action not found"
            exit 1
          fi
        shell: bash

  test-action-dry-run:
    name: ğŸ§ª Test Action (Dry Run)
    runs-on: ubuntu-latest
    needs: test-fusion-publish
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Build action
        run: |
          npm ci
          npm run build

      - name: ğŸ¯ Test Action Setup
        uses: ./
        with:
          tag: 'test-v1.0.0'
          stage: 'testing'
          api-id: 'test-api'
          api-key: 'test-key'
        continue-on-error: true

  create-release:
    name: ğŸš€ Create Release
    runs-on: ubuntu-latest
    needs: [test-fusion-publish, test-action-dry-run]
    if: startsWith(github.ref, 'refs/tags/v')  # Only run on version tags
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Get tag name
        id: get-tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Tag: $TAG"

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ”¨ Build action
        run: |
          npm ci
          npm run build

      - name: ğŸ“‹ Commit built files to tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f dist/
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ”¨ Add built files for ${{ steps.get-tag.outputs.tag }}"
            # Update the tag to point to this new commit
            git tag -fa ${{ steps.get-tag.outputs.tag }} -m "Release ${{ steps.get-tag.outputs.tag }}"
            git push origin ${{ steps.get-tag.outputs.tag }} --force
          fi

      - name: ğŸ“ Generate release notes
        id: generate-notes
        run: |
          # Generate release notes (customize as needed)
          cat << EOF > release_notes.md
          ## What's Changed
          
          Release ${{ steps.get-tag.outputs.tag }} of the Nitro Fusion Publish Action.
          
          ## Usage
          
          \`\`\`yaml
          - uses: ChilliCream/nitro-fusion-publish-action@${{ steps.get-tag.outputs.tag }}
            with:
              tag: 'v1.0.0'
              stage: 'production'
              api-id: 'my-api'
              api-key: \${{ secrets.NITRO_API_KEY }}
          \`\`\`
          
          ## Supported Platforms
          - âœ… Linux (x64, ARM64)
          - âœ… macOS (x64, Apple Silicon)  
          - âœ… Windows (x64)
          
          **Full Changelog**: https://github.com/ChilliCream/nitro-fusion-publish-action/commits/${{ steps.get-tag.outputs.tag }}
          EOF

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get-tag.outputs.tag }}
          name: ${{ steps.get-tag.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get-tag.outputs.tag, '-') }}  # Mark as prerelease if tag contains - (e.g., v1.0.0-beta)
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}